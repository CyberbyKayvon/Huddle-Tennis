<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Profile Component</title>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --surface: #f9fafb;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #1f2937;
            border-bottom: 3px solid #6366f1;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #6366f1;
        }
        
        /* Feed posts container for profile */
        .feed-posts {
            background: white;
            min-height: 400px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        /* Test controls */
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6366f1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 5px;
        }
        
        /* Profile specific styles */
        .profile-header {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .profile-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            position: relative;
            font-weight: 500;
        }
        
        .profile-tab.active {
            color: #1f2937;
        }
        
        .tab-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #6366f1;
            border-radius: 3px 3px 0 0;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="test-container">
        <h1>üë§ Profile Component Test</h1>
        
        <div class="test-section">
            <h3>Component Status</h3>
            <div id="component-status"></div>
        </div>
        
        <div class="test-section">
            <h3>Test Profile Display</h3>
            <div class="feed-posts" id="profile-container">
                <!-- Profile will render here -->
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Controls</h3>
            <div class="test-controls">
                <button onclick="loadOwnProfile()">Load Own Profile</button>
                <button onclick="loadTestProfile()">Load Test User</button>
                <button onclick="testEditModal()">Test Edit Modal</button>
                <button onclick="testTabSwitching()">Test Tab Switching</button>
                <button onclick="testFollow()">Test Follow Toggle</button>
                <button onclick="simulateNoUser()">Test No User State</button>
                <button onclick="simulateError()">Test Error State</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="api-calls">0</div>
                    <div class="stat-label">API Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="profile-user">None</div>
                    <div class="stat-label">Current User</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="profile-type">None</div>
                    <div class="stat-label">Profile Type</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-tab">posts</div>
                    <div class="stat-label">Active Tab</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
            <button onclick="runAllTests()" style="margin-top: 15px;">Run All Tests</button>
        </div>
    </div>

    <script type="module">
        import { profileComponent } from '/js/components/profile-component.js';
        import { apiService } from '/js/core/services/api-service.js';
        import { API_ENDPOINTS } from '/js/core/config/api-endpoints.js';
        import { storageService } from '/js/core/services/storage-service.js';
        
        // Make available globally
        window.profileComponent = profileComponent;
        
        const resultsDiv = document.getElementById('test-results');
        let apiCallCount = 0;
        
        // Mock user data
        const mockCurrentUser = {
            id: 'user123',
            username: 'testuser',
            displayName: 'Test User',
            bio: 'This is a test bio',
            stats: {
                posts: 42,
                followers: 150,
                following: 75,
                wins: 25,
                losses: 10,
                accuracy: 71,
                streak: 3,
                rank: 15
            },
            degenCoins: 500,
            verified: true,
            paymentMethods: {
                venmo: '@testuser',
                cashapp: '$testuser'
            }
        };
        
        const mockOtherUser = {
            id: 'user456',
            username: 'johndoe',
            displayName: 'John Doe',
            bio: 'Sports betting enthusiast',
            stats: {
                posts: 128,
                followers: 500,
                following: 200,
                wins: 100,
                losses: 50,
                accuracy: 67,
                streak: -2,
                rank: 5
            },
            degenCoins: 1500,
            verified: false,
            isFollowing: false
        };
        
        const mockPosts = [
            {
                _id: 'post1',
                content: 'Taking the over on this game!',
                author: mockCurrentUser,
                createdAt: new Date().toISOString(),
                likes: { length: 10 },
                comments: { length: 5 }
            },
            {
                _id: 'post2',
                content: 'Chiefs -3.5 is a lock üîí',
                author: mockCurrentUser,
                createdAt: new Date(Date.now() - 86400000).toISOString(),
                likes: { length: 25 },
                comments: { length: 8 }
            }
        ];
        
        const mockPredictions = [
            {
                pick: 'Chiefs -3.5',
                game: 'Chiefs vs Raiders',
                confidence: 85,
                result: 'won'
            },
            {
                pick: 'Over 48.5',
                game: 'Bills vs Dolphins',
                confidence: 70,
                result: 'pending'
            }
        ];
        
        // Mock auth service
        window.authService = {
            getCurrentUser: () => mockCurrentUser
        };
        
        // Mock API responses
        apiService.get = async function(endpoint) {
            apiCallCount++;
            document.getElementById('api-calls').textContent = apiCallCount;
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 300));
            
            if (endpoint.includes('/users/testuser')) {
                if (endpoint.includes('/posts')) {
                    return { posts: mockPosts };
                }
                if (endpoint.includes('/predictions')) {
                    return { predictions: mockPredictions };
                }
                return { success: true, user: mockCurrentUser };
            }
            
            if (endpoint.includes('/users/johndoe')) {
                if (endpoint.includes('/posts')) {
                    return { posts: [] };
                }
                if (endpoint.includes('/predictions')) {
                    return { predictions: [] };
                }
                return { success: true, user: mockOtherUser };
            }
            
            if (endpoint.includes('/users/notfound')) {
                return { success: false };
            }
            
            return { success: false };
        };
        
        apiService.put = async function(endpoint, data) {
            apiCallCount++;
            document.getElementById('api-calls').textContent = apiCallCount;
            await new Promise(resolve => setTimeout(resolve, 500));
            return { success: true };
        };
        
        apiService.post = async function(endpoint) {
            apiCallCount++;
            document.getElementById('api-calls').textContent = apiCallCount;
            await new Promise(resolve => setTimeout(resolve, 300));
            return { success: true };
        };
        
        function updateComponentStatus() {
            const statusDiv = document.getElementById('component-status');
            const isLoaded = typeof profileComponent !== 'undefined';
            
            statusDiv.innerHTML = `
                <p>‚úÖ Component Loaded: ${isLoaded}</p>
                <p>Current User: ${profileComponent.currentUser?.username || 'None'}</p>
                <p>Viewing User: ${profileComponent.viewingUser?.username || 'None'}</p>
                <p>Is Own Profile: ${profileComponent.isOwnProfile}</p>
                <p>Methods Available: 
                    ${typeof profileComponent?.loadProfile === 'function' ? '‚úÖ' : '‚ùå'} loadProfile,
                    ${typeof profileComponent?.openEditModal === 'function' ? '‚úÖ' : '‚ùå'} openEditModal,
                    ${typeof profileComponent?.showTab === 'function' ? '‚úÖ' : '‚ùå'} showTab,
                    ${typeof profileComponent?.toggleFollow === 'function' ? '‚úÖ' : '‚ùå'} toggleFollow
                </p>
            `;
        }
        
        window.loadOwnProfile = async function() {
            addResult('Loading own profile...', 'info');
            await profileComponent.loadProfile();
            document.getElementById('profile-user').textContent = 'testuser';
            document.getElementById('profile-type').textContent = 'Own';
            addResult('‚úÖ Own profile loaded', 'success');
            updateComponentStatus();
        }
        
        window.loadTestProfile = async function() {
            addResult('Loading test user profile...', 'info');
            await profileComponent.loadProfile('johndoe');
            document.getElementById('profile-user').textContent = 'johndoe';
            document.getElementById('profile-type').textContent = 'Other';
            addResult('‚úÖ Test user profile loaded', 'success');
            updateComponentStatus();
        }
        
        window.testEditModal = function() {
            if (!profileComponent.isOwnProfile) {
                addResult('‚ö†Ô∏è Load own profile first', 'warning');
                return;
            }
            
            addResult('Opening edit modal...', 'info');
            profileComponent.openEditModal();
            
            setTimeout(() => {
                if (document.getElementById('profileEditModal')) {
                    addResult('‚úÖ Edit modal opened', 'success');
                    // Close it after a moment
                    setTimeout(() => {
                        profileComponent.closeEditModal();
                        addResult('‚úÖ Edit modal closed', 'success');
                    }, 2000);
                } else {
                    addResult('‚ùå Edit modal failed to open', 'error');
                }
            }, 100);
        }
        
        window.testTabSwitching = function() {
            if (!profileComponent.viewingUser) {
                addResult('‚ö†Ô∏è Load a profile first', 'warning');
                return;
            }
            
            const tabs = ['posts', 'predictions', 'bets', 'stats'];
            let index = 0;
            
            const switchTab = () => {
                if (index >= tabs.length) {
                    addResult('‚úÖ All tabs tested', 'success');
                    return;
                }
                
                profileComponent.showTab(tabs[index]);
                document.getElementById('active-tab').textContent = tabs[index];
                addResult(`Switched to ${tabs[index]} tab`, 'info');
                index++;
                
                setTimeout(switchTab, 800);
            };
            
            switchTab();
        }
        
        window.testFollow = async function() {
            if (profileComponent.isOwnProfile) {
                addResult('‚ö†Ô∏è Load another user\'s profile first', 'warning');
                return;
            }
            
            addResult('Testing follow toggle...', 'info');
            await profileComponent.toggleFollow('user456');
            addResult('‚úÖ Follow toggle executed', 'success');
        }
        
        window.simulateNoUser = async function() {
            addResult('Simulating user not found...', 'info');
            await profileComponent.loadProfile('notfound');
            addResult('‚úÖ User not found state displayed', 'success');
        }
        
        window.simulateError = async function() {
            addResult('Simulating error state...', 'info');
            
            // Temporarily break the API
            const originalGet = apiService.get;
            apiService.get = async () => { throw new Error('Test error'); };
            
            await profileComponent.loadProfile('errortest');
            
            // Restore API
            apiService.get = originalGet;
            
            addResult('‚úÖ Error state displayed', 'success');
        }
        
        window.runAllTests = async function() {
            resultsDiv.innerHTML = '';
            addResult('<h4>Running All Tests...</h4>', 'info');
            
            // Test 1: Component loaded
            if (typeof profileComponent !== 'undefined') {
                addResult('‚úÖ Component loaded successfully', 'success');
            } else {
                addResult('‚ùå Component not loaded', 'error');
                return;
            }
            
            // Test 2: Load own profile
            await loadOwnProfile();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (profileComponent.viewingUser?.username === 'testuser') {
                addResult('‚úÖ Own profile data correct', 'success');
            } else {
                addResult('‚ùå Own profile data incorrect', 'error');
            }
            
            // Test 3: Tab switching
            const tabs = ['predictions', 'bets', 'stats', 'posts'];
            for (const tab of tabs) {
                profileComponent.showTab(tab);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            addResult('‚úÖ Tab switching works', 'success');
            
            // Test 4: Load other user profile
            await loadTestProfile();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (profileComponent.viewingUser?.username === 'johndoe') {
                addResult('‚úÖ Other user profile loaded', 'success');
            }
            
            // Test 5: XSS prevention
            const maliciousUser = {
                ...mockCurrentUser,
                displayName: '<' + 'script>alert("XSS")<' + '/script>',
                bio: '<img src=x onerror="alert(1)">'
            };
            
            profileComponent.viewingUser = maliciousUser;
            const html = profileComponent.createProfileHTML();
            
            if (!html.includes('script>') && !html.includes('onerror')) {
                addResult('‚úÖ XSS prevention working', 'success');
            } else {
                addResult('‚ùå XSS vulnerability detected', 'error');
            }
            
            addResult('<h4>All tests complete!</h4>', 'info');
            updateComponentStatus();
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        // Initialize
        updateComponentStatus();
        
        // Auto-load own profile
        setTimeout(() => {
            loadOwnProfile();
        }, 500);
    </script>
</body>
</html>