<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Handshake Realtime</title>
    <style>
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --accent: #8b5cf6;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --surface: #f9fafb;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #1f2937;
            border-bottom: 3px solid #6366f1;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        /* Bet challenge styles */
        .feed-posts {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        .bet-challenge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: white;
        }
        
        .handshake-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            margin: 20px 0;
            font-size: 3rem;
            transition: all 0.3s ease;
        }
        
        .handshake-container[data-gap="0"] {
            gap: 100px;
        }
        
        .handshake-container[data-gap="1"] {
            gap: 80px;
        }
        
        .handshake-container[data-gap="2"] {
            gap: 60px;
        }
        
        .handshake-container[data-gap="3"] {
            gap: 40px;
        }
        
        .handshake-container[data-gap="4"] {
            gap: 20px;
        }
        
        .handshake-container[data-gap="5"] {
            gap: 10px;
        }
        
        .handshake-container[data-gap="full"] {
            gap: 0;
            background: rgba(16, 185, 129, 0.2);
        }
        
        .hand-left, .hand-right {
            transition: all 0.3s ease;
        }
        
        .handshake-joined {
            animation: celebrate 0.5s ease infinite alternate;
        }
        
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-20deg); }
            75% { transform: rotate(20deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(5deg); }
        }
        
        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
        }
        
        .bet-progress {
            text-align: center;
            margin: 20px 0;
        }
        
        .participants {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }
        
        .participant {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        button {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin: 5px;
        }
        
        button:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        
        .accept-btn {
            background: #10b981;
        }
        
        .accept-btn:hover {
            background: #059669;
        }
        
        .cancel-btn {
            background: #ef4444;
        }
        
        .cancel-btn:hover {
            background: #dc2626;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6366f1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ü§ù Handshake Realtime Test</h1>
        
        <div class="test-section">
            <h3>Component Status</h3>
            <div id="component-status"></div>
        </div>
        
        <div class="test-section">
            <h3>Live Bet Monitoring</h3>
            <div class="feed-posts">
                <!-- Test Bet 1 - Empty -->
                <div class="bet-challenge" data-bet-id="bet-001" data-post-id="post-001" data-max-accepts="3">
                    <h4>Test Bet #1 - No Acceptances</h4>
                    <div class="handshake-container" data-gap="0">
                        <span class="hand-left">ü§ö</span>
                        <span class="hand-right">‚úã</span>
                    </div>
                    <div class="progress-text">Looking for opponents...</div>
                    <div class="participants"></div>
                    <div class="bet-progress"></div>
                </div>
                
                <!-- Test Bet 2 - Partially Filled -->
                <div class="bet-challenge" data-bet-id="bet-002" data-post-id="post-002" data-max-accepts="5">
                    <h4>Test Bet #2 - Partially Filled</h4>
                    <div class="handshake-container" data-gap="2">
                        <span class="hand-left">ü§ö</span>
                        <span class="hand-right">‚úã</span>
                    </div>
                    <div class="progress-text">2/5 spots taken</div>
                    <div class="participants">
                        <div class="participant">‚úÖ User1</div>
                        <div class="participant">‚úÖ User2</div>
                    </div>
                    <div class="bet-progress"></div>
                </div>
                
                <!-- Test Bet 3 - Full -->
                <div class="bet-challenge" data-bet-id="bet-003" data-post-id="post-003" data-max-accepts="3">
                    <h4>Test Bet #3 - Full</h4>
                    <div class="handshake-container" data-gap="full">
                        <span class="handshake-joined">ü§ù</span>
                    </div>
                    <div class="progress-text">‚úÖ All spots filled!</div>
                    <div class="participants">
                        <div class="participant">‚úÖ User1</div>
                        <div class="participant">‚úÖ User2</div>
                        <div class="participant">‚úÖ User3</div>
                    </div>
                    <div class="bet-progress"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Polling Status</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="active-polls">0</div>
                    <div class="stat-label">Active Polls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="poll-interval">2s</div>
                    <div class="stat-label">Poll Interval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="api-calls">0</div>
                    <div class="stat-label">API Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="last-update">Never</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Controls</h3>
            <button onclick="simulateAcceptance()">Simulate Bet Acceptance</button>
            <button onclick="simulateFull()">Simulate Full Bet</button>
            <button onclick="addNewBet()">Add New Bet</button>
            <button onclick="stopAllPolling()">Stop All Polling</button>
            <button onclick="restartPolling()">Restart Polling</button>
            <button onclick="runAllTests()">Run All Tests</button>
        </div>
        
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <script type="module">
        import { handshakeRealtime } from '/js/components/handshake-realtime.js';
        import { apiService } from '/js/core/services/api-service.js';
        import { API_ENDPOINTS } from '/js/core/config/api-endpoints.js';
        
        // Make available globally
        window.handshakeRealtime = handshakeRealtime;
        
        const resultsDiv = document.getElementById('test-results');
        let apiCallCount = 0;
        let mockBetStates = {
            'post-001': { acceptedBy: [], status: 'open', participants: [] },
            'post-002': { acceptedBy: ['user1', 'user2'], status: 'open', participants: [{username: 'User1'}, {username: 'User2'}] },
            'post-003': { acceptedBy: ['user1', 'user2', 'user3'], status: 'open', participants: [{username: 'User1'}, {username: 'User2'}, {username: 'User3'}] }
        };
        
        // Mock API responses
        apiService.get = async function(endpoint) {
            apiCallCount++;
            document.getElementById('api-calls').textContent = apiCallCount;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            // Extract post ID from endpoint
            const match = endpoint.match(/posts\/([^\/]+)/);
            if (match) {
                const postId = match[1];
                const betState = mockBetStates[postId];
                
                if (betState) {
                    return {
                        post: {
                            _id: postId,
                            author: { _id: 'author123' },
                            challengeBet: betState
                        }
                    };
                }
            }
            
            return null;
        };
        
        function updateComponentStatus() {
            const statusDiv = document.getElementById('component-status');
            const isLoaded = typeof handshakeRealtime !== 'undefined';
            const pollCount = handshakeRealtime?.activePolls?.size || 0;
            
            statusDiv.innerHTML = `
                <p>‚úÖ Component Loaded: ${isLoaded}</p>
                <p>Active Polls: ${pollCount}</p>
                <p>Poll Interval: ${handshakeRealtime?.pollInterval}ms</p>
                <p>Methods Available: 
                    ${typeof handshakeRealtime?.init === 'function' ? '‚úÖ' : '‚ùå'} init,
                    ${typeof handshakeRealtime?.startPolling === 'function' ? '‚úÖ' : '‚ùå'} startPolling,
                    ${typeof handshakeRealtime?.stopPolling === 'function' ? '‚úÖ' : '‚ùå'} stopPolling,
                    ${typeof handshakeRealtime?.updateBetStatus === 'function' ? '‚úÖ' : '‚ùå'} updateBetStatus
                </p>
            `;
            
            document.getElementById('active-polls').textContent = pollCount;
        }
        
        window.simulateAcceptance = function() {
            addResult('Simulating bet acceptance...', 'info');
            
            // Update mock state
            mockBetStates['post-001'].acceptedBy.push('newuser');
            mockBetStates['post-001'].participants.push({username: 'NewUser'});
            
            // Force update
            handshakeRealtime.updateBetStatus('bet-001', 'post-001');
            
            addResult('‚úÖ Simulated acceptance for Bet #1', 'success');
        }
        
        window.simulateFull = function() {
            addResult('Simulating full bet...', 'info');
            
            // Fill up bet 2
            mockBetStates['post-002'].acceptedBy = ['user1', 'user2', 'user3', 'user4', 'user5'];
            mockBetStates['post-002'].participants = [
                {username: 'User1'}, {username: 'User2'}, 
                {username: 'User3'}, {username: 'User4'}, {username: 'User5'}
            ];
            
            // Force update
            handshakeRealtime.updateBetStatus('bet-002', 'post-002');
            
            addResult('‚úÖ Bet #2 is now full', 'success');
        }
        
        window.addNewBet = function() {
            const betCount = document.querySelectorAll('.bet-challenge').length + 1;
            const betId = `bet-00${betCount}`;
            const postId = `post-00${betCount}`;
            
            // Add to mock states
            mockBetStates[postId] = { acceptedBy: [], status: 'open', participants: [] };
            
            // Create new bet element
            const newBet = document.createElement('div');
            newBet.className = 'bet-challenge';
            newBet.dataset.betId = betId;
            newBet.dataset.postId = postId;
            newBet.dataset.maxAccepts = '3';
            
            newBet.innerHTML = `
                <h4>Test Bet #${betCount} - New</h4>
                <div class="handshake-container" data-gap="0">
                    <span class="hand-left">ü§ö</span>
                    <span class="hand-right">‚úã</span>
                </div>
                <div class="progress-text">Looking for opponents...</div>
                <div class="participants"></div>
                <div class="bet-progress"></div>
            `;
            
            document.querySelector('.feed-posts').appendChild(newBet);
            
            // Start monitoring
            handshakeRealtime.monitorVisibleBets();
            
            addResult(`‚úÖ Added new bet #${betCount}`, 'success');
            updateComponentStatus();
        }
        
        window.stopAllPolling = function() {
            handshakeRealtime.destroy();
            addResult('‚úÖ All polling stopped', 'success');
            updateComponentStatus();
        }
        
        window.restartPolling = function() {
            handshakeRealtime.init();
            addResult('‚úÖ Polling restarted', 'success');
            updateComponentStatus();
        }
        
        window.runAllTests = async function() {
            resultsDiv.innerHTML = '';
            addResult('<h4>Running All Tests...</h4>', 'info');
            
            // Test 1: Component loaded
            if (typeof handshakeRealtime !== 'undefined') {
                addResult('‚úÖ Component loaded successfully', 'success');
            } else {
                addResult('‚ùå Component not loaded', 'error');
                return;
            }
            
            // Test 2: Initialization
            handshakeRealtime.init();
            if (handshakeRealtime.activePolls.size > 0) {
                addResult(`‚úÖ Polling initialized for ${handshakeRealtime.activePolls.size} bets`, 'success');
            } else {
                addResult('‚ö†Ô∏è No active polls (may be normal)', 'info');
            }
            
            // Test 3: Visual updates
            await handshakeRealtime.updateBetStatus('bet-001', 'post-001');
            const bet1 = document.querySelector('[data-bet-id="bet-001"]');
            if (bet1) {
                addResult('‚úÖ Visual updates working', 'success');
            }
            
            // Test 4: Polling mechanism
            const initialCalls = apiCallCount;
            await new Promise(resolve => setTimeout(resolve, 2500));
            if (apiCallCount > initialCalls) {
                addResult('‚úÖ Polling is active', 'success');
            } else {
                addResult('‚ö†Ô∏è Polling may not be running', 'warning');
            }
            
            // Test 5: Cleanup
            const pollsBefore = handshakeRealtime.activePolls.size;
            handshakeRealtime.destroy();
            if (handshakeRealtime.activePolls.size === 0) {
                addResult('‚úÖ Cleanup working', 'success');
            }
            
            // Restart after tests
            handshakeRealtime.init();
            
            addResult('<h4>All tests complete!</h4>', 'info');
            updateComponentStatus();
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        // Initialize and start monitoring
        updateComponentStatus();
        
        // Update status every second
        setInterval(updateComponentStatus, 1000);
    </script>
</body>
</html>